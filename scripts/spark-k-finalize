#!/bin/sh

#
# Spark on K finalize script
#

#
# K Job system forcibly exports POSIXY_CORRECT, so unset it.
#
unset POSIXLY_CORRECT

if [ -d /opt/spark ]; then
  SPARK_HOME=/opt/spark
else if [ -f ./spark-1.6.0-bin-custom-spark.tgz ]; then
  # Spark がインストールされていないため、rank 0 のノードに tar ボールが置かれている想定
  tar zxf spark-1.6.0-bin-custom-spark.tgz
  mv ./spark-1.6.0-bin-custom-spark ../spark-1.6.0-bin-custom-spark
  SPARK_HOME=`pwd`/../spark-1.6.0-bin-custom-spark
  SPARK_HOME=`(cd ${SPARK_HOME}; pwd)`
else
  # Expects spark-submit is in PATH
  spark_sumit=`which spark-submit 2> /dev/null`
  if [ $? -eq 0 ]; then
    dir=`dirname $spark_sumit`
    SPARK_HOME=`cd $dir; ..`
  fi
fi; fi;

if [ -z "$SPARK_HOME" ]; then
  echo "Spark doesn't exists"
  exit 1
fi

rankdir=`pwd`
common_dir=`(cd ..; pwd)`

mpiexec /work/system/bin/msh /bin/bash ${common_dir}/stop-slave.sh

SPARK_CONF_DIR=${COMMON_DIR}/conf \
SPARK_LOCAL_DIRS=${rankdir}/localdir \
SPARK_WORKER_DIR=${rankdir}/work \
SPARK_LOG_DIR=${rankdir}/logs \
SPARK_PID_DIR=${rankdir}/pids \
${SPARK_HOME}/sbin/stop-master.sh
